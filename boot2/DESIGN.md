# 設計

## 言語仕様

### 実装アイディア

- [ ] 形無しのポエムを書く
- [ ] Lisp風のマクロを用意する
    - [ ] 構文木APIを整備する

### 型無し

当面は記述量を減らすことを目的にする。

- [x] 型無しのLuaサブセットをWASMにコンパイルする
- [x] 文字列リテラル引数のサポート
    - [x] NUDに移動する
- [x] Luaのビット演算はunsignedなのでは？
    - 右シフトだけunsignedにした
- [x] ブロックコメント
- [x] ノードの定義を行う
    - [x] トークンとノードをリファクタリングする
- [x] 無名関数を定義する
- [-] ローカル関数を定義する
    - 再帰の扱いは？
- [x] チャンク直下と関数内を区別する
- [x] 文字列比較の短縮
- [x] 返り値の個数を確認する
    - [x] explist,argsで末尾以外の多値を1個にしない
    - [x] tableも
    - [x] 個数の計算は連立一次方程式に帰着する
- [-] dotをNameに含めてしまうハック
- [-] 初期化無しのローカルを許可する
- [x] 整数リテラルのパススルー
    - watの整数は10進数と16進数
- [x] ファイルIOのサポート
- [x] 引数のサポート
- [x] requireのサポート
- [x] インクルードディレクトリ名を考える
- [x] ソースコード情報の強化
- [-] WASMのname?のサポート
- [-] パーサのcallの整理
- [x] メモリ量の測定
- [x] itemsが空の場合の追加情報
- [x] 文字列キーのテーブルの簡易サポート
- [x] assertのサポート
- [x] ファイルオープンはエラーで落とさない
- [x] unreachableで落とさずにexitで落とす
- [ ] DFSの関数化の検討
- [ ] 属性の整理

### 静的型付け

- [ ] 配列・タプル・構造体を導入する
- [ ] 基本型と関数型を導入する
- [ ] Genericsの導入を検討する
- [ ] カンマ区切りリストと多値返却の相性を検討する
- [ ] Hindley-Milnerのアルゴリズムを勉強する

### 問題

- 構造体のサイズ計算や検索を手作業でなんとかしなければならないこと。
- 関数ポインタの型が消えてしまうこと。
    - 引数の個数と返り値の個数は保持したい。
    - 関数ポインタは小さい定数インデックスなので、どこかに余分な情報を持てない？
        - それだと動的な型になってしまうのでは。
        - コンパイル時定数であることは確かなので型推論できる？

## メモリ

- [x] スタックメモリを使うかどうか検討する
- [x] スタックメモリを実装する
- [ ] GCを採用するか検討する
    - [ ] u8 arrayで文字列を表現する
    - 文字列リテラルが静的アドレスを取らなくなる
    - `__new_literal(size, data)`

## WASM

- [ ] GCについてはメモリの項目と同じ
- [ ] WITの仕様を確認する
- [ ] コンポーネントまわりでアラインメントのアルゴリズムもあるはず
- [ ] 例外仕様を確認する
